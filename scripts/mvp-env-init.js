const fs = require('node:fs');
const path = require('node:path');
const crypto = require('node:crypto');

function parseArgs() {
  const args = process.argv.slice(2);
  let envTarget = 'staging';
  let force = false;

  for (const arg of args) {
    if (arg.startsWith('--env=')) {
      envTarget = arg.slice('--env='.length).trim().toLowerCase();
    } else if (arg === '--force') {
      force = true;
    }
  }

  if (envTarget !== 'staging' && envTarget !== 'prod') {
    throw new Error('Argumento inv√°lido: --env debe ser staging o prod.');
  }

  return { envTarget, force };
}

function randomSecret() {
  return crypto.randomBytes(48).toString('base64url');
}

function buildTemplate(envTarget) {
  const isProd = envTarget === 'prod';
  const webUrl = isProd ? 'https://app.example.com' : 'https://staging-app.example.com';
  const apiUrl = isProd ? 'https://api.example.com' : 'https://staging-api.example.com';
  const dbUrl = isProd
    ? 'postgresql://prod_user:prod_pass@prod-db.example.com:5432/apoint'
    : 'postgresql://staging_user:staging_pass@staging-db.example.com:5432/apoint';
  const redisUrl = isProd ? 'redis://prod-redis.example.com:6379' : 'redis://staging-redis.example.com:6379';
  const fromEmail = isProd ? 'no-reply@example.com' : 'no-reply@staging.example.com';

  const lines = [
    `NODE_ENV=${isProd ? 'production' : 'staging'}`,
    `NEXT_PUBLIC_API_URL=${apiUrl}`,
    `STAGING_API_URL=${isProd ? '' : apiUrl}`,
    `PROD_API_URL=${isProd ? apiUrl : ''}`,
    'PORT=3001',
    `DATABASE_URL=${dbUrl}`,
    `REDIS_URL=${redisUrl}`,
    `JWT_ACCESS_SECRET=${randomSecret()}`,
    `JWT_REFRESH_SECRET=${randomSecret()}`,
    'SENDGRID_API_KEY=',
    `SENDGRID_FROM_EMAIL=${fromEmail}`,
    `SMTP_HOST=${isProd ? 'smtp.example.com' : 'smtp.staging.example.com'}`,
    'SMTP_PORT=587',
    'SMTP_SECURE=false',
    `SMTP_USER=${isProd ? 'prod-smtp-user' : 'staging-smtp-user'}`,
    `SMTP_PASS=${isProd ? 'prod-smtp-pass' : 'staging-smtp-pass'}`,
    `SMTP_FROM_EMAIL=${fromEmail}`,
    `NOTIFICATIONS_BUSINESS_EMAIL=${isProd ? 'owner@example.com' : 'owner@staging.example.com'}`
  ];

  return `# Auto-generated by scripts/mvp-env-init.js (${new Date().toISOString()})\n${lines.join('\n')}\n`;
}

function run() {
  const { envTarget, force } = parseArgs();
  const fileName = envTarget === 'staging' ? '.env.staging' : '.env.prod';
  const filePath = path.join(process.cwd(), fileName);

  if (fs.existsSync(filePath) && !force) {
    console.log(`${fileName} ya existe. Usa --force para regenerar.`);
    return;
  }

  fs.writeFileSync(filePath, buildTemplate(envTarget), 'utf8');
  console.log(`Archivo ${fileName} generado correctamente.`);
}

try {
  run();
} catch (error) {
  const message = error instanceof Error ? error.message : String(error);
  console.error(`Error en mvp-env-init: ${message}`);
  process.exit(1);
}
